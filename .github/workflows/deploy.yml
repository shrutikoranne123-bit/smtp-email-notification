name: Deploy to EC2

on:
  workflow_run:
    workflows: ["ARM64 Docker Build"]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy
        run: |
          ssh ec2-user@<EC2_PUBLIC_IP> << EOF
          docker rm -f arm64-demo || true
          docker run -d \
            --name arm64-demo \
            -p 3000:3000 \
            arm64-demo:latest
          EOF

      # âœ… Success email
      - name: Notify Deployment Success
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸš€ Deployment Successful"
          to: ${{ secrets.SMTP_TO }}
          from: ${{ secrets.SMTP_FROM }}
          body: |
            Deployment successful âœ…
            Repo: ${{ github.repository }}

      # âŒ Failure email
      - name: Notify Deployment Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âŒ Deployment Failed"
          to: ${{ secrets.SMTP_TO }}
          from: ${{ secrets.SMTP_FROM }}
          body: |
            Deployment failed âŒ
            Check GitHub Actions logs.